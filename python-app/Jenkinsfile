pipeline {
    agent any

    environment {
        DEPLOY_DIR = "${WORKSPACE}/deploy/python-app"
        PATH = "/var/lib/jenkins/.local/bin:${PATH}"
        EMAIL_TO = "bitboxtraining@gmail.com"
    }

    stages {
        stage('Prepare') {
            steps {
                echo "üßπ Cleaning workspace..."
                cleanWs()
            }
        }

        stage('Install') {
            steps {
                dir('python-app') {
                    sh '''
                        echo "üêç Installing Python dependencies..."
                        if [ -f requirements.txt ]; then
                            pip install --user -r requirements.txt
                        else
                            echo "‚ö†Ô∏è No requirements.txt found, skipping dependency install."
                        fi
                    '''
                }
            }
        }

        stage('Lint') {
            steps {
                dir('python-app') {
                    sh '''
                        echo "üîç Linting code..."
                        if command -v flake8 >/dev/null 2>&1; then
                            flake8 . || echo "‚ö†Ô∏è Lint warnings detected"
                        else
                            echo "‚ÑπÔ∏è flake8 not installed, skipping lint."
                        fi
                    '''
                }
            }
        }

        stage('Test') {
            steps {
                dir('python-app') {
                    sh '''
                        echo "üß™ Running tests..."
                        pytest -q --disable-warnings || echo "‚ö†Ô∏è Tests failed or not found"
                    '''
                }
            }
        }

        stage('Deploy') {
            steps {
                dir('python-app') {
                    sh '''
                        echo "üöÄ Deploying application..."
                        mkdir -p $DEPLOY_DIR
                        cp -r app.py requirements.txt $DEPLOY_DIR/ || true
                        echo "‚úÖ App deployed to $DEPLOY_DIR"
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "üéâ Build succeeded!"
            script {
                try {
                    emailext (
                        subject: "‚úÖ SUCCESS: Python App Pipeline",
                        body: """\
                            <h3>üéâ Build Successful</h3>
                            <p>The Python application has been successfully tested and deployed.</p>
                            <ul>
                              <li><b>Job:</b> ${env.JOB_NAME}</li>
                              <li><b>Build #:</b> ${env.BUILD_NUMBER}</li>
                              <li><b>URL:</b> <a href='${env.BUILD_URL}'>${env.BUILD_URL}</a></li>
                            </ul>
                        """,
                        to: "${EMAIL_TO}",
                        mimeType: 'text/html'
                    )
                } catch (err) {
                    echo "‚úâÔ∏è Email not sent: ${err}"
                }
            }
        }

        failure {
            echo "‚ùå Build failed!"
            script {
                try {
                    emailext (
                        subject: "‚ùå FAILURE: Python App Pipeline",
                        body: """\
                            <h3>üö® Build Failed</h3>
                            <p>One or more stages of the Python pipeline failed.</p>
                            <ul>
                              <li><b>Job:</b> ${env.JOB_NAME}</li>
                              <li><b>Build #:</b> ${env.BUILD_NUMBER}</li>
                              <li><b>URL:</b> <a href='${env.BUILD_URL}'>${env.BUILD_URL}</a></li>
                            </ul>
                        """,
                        to: "${EMAIL_TO}",
                        mimeType: 'text/html'
                    )
                } catch (err) {
                    echo "‚úâÔ∏è Email not sent: ${err}"
                }
            }
        }
    }
}
